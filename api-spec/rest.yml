openapi: '3.0.2'
info:
  title: Transcendence backend REST API
  version: '1.0'
servers:
  - url: https://api.server.test/v1
components:
  schemas:
    GeneralError:
      type: object
      properties:
        code:
          type: integer
          minimum: 100
          maximum: 600
        message:
          type: string
    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        avatar:
          type: string
    UserCreate:
      type: object
      properties:
        name:
          type: string
        avatar:
          type: string
        password:
          type: string
        email:
          type: string
        is_staff:
          type: boolean
          default: false
        is_superuser:
          type: boolean
          default: false
      required:
        - "name"
        - "password"
        - "email"

    UserUpdate:
      type: object
      properties:
        name:
          type: string
        avatar:
          type: string
        password:
          type: string

    FriendRequest:
      type: object
      properties:
        id:
          type: integer
        sender_id: 
          type: integer
        sender_username:
          type: string
        message:
          type: string

    GameCreate:
      type: object
      properties:
        user_id:
          type: integer
      required:
       - "user_id"

    Game:
      type: object
      properties:
        game_id:
          type: integer
        active:
          type: boolean
        users:
          type: array
          items:
            type: object
            properties:
              user_id:
                type: integer
              score:
                type: integer
    
    Chat:
      type: object
      properties:
        id:
          type: integer
        participants:
          type: array
          items:
            type: object
            properties:
              user_id:
                type: integer
        name:
          type: string

    Message:
      type: object
      properties:
        id:
          type: integer
        chat_id:
          type: integer
        timestamp:
          type: string
        sender:
          type: integer
        read:
          type: boolean
        content:
          type: string

  parameters:
    skipParam:
      name: skip
      in: query
      description: number of items to skip
      required: true
      schema:
        type: integer
        format: int32
    limitParam:
      name: limit
      in: query
      description: max records to return
      required: true
      schema:
        type: integer
        format: int32
    activeParam:
      name: active
      in: query
      description: active games
      required: false
      schema:
        type: boolean
  responses:
    GeneralError:
      description: General Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GeneralError'
    OK:
      description: OK
      content:
        text/plain:
          schema:
            type: string
  securitySchemes:
    auth:
      type: oauth2
      flows: 
        implicit:
          authorizationUrl: https://example.org/api/oauth/dialog
          scopes:
            write:users: modify users
            read:users: read users
paths:
  /healthcheck:
    get:
      tags: 
        - healthcheck
      responses:
        '200':
          $ref: '#/components/responses/OK'
        default:
          $ref: '#/components/responses/GeneralError'

  /login:
    post:
      tags:
        - login
      requestBody:
        content:
          'application/json':
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: "Successful login"
          headers:
            Set-Cookie:
              description: "Session ID cookie"
              schema:
                type: string
            Location:
              description: "Redirect location"
              schema:
                type: string
              example: "/users/me"
        default:
          $ref: '#/components/responses/GeneralError'
  /logout:
    post:
      tags:
          - login
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: "Successful logout of user"
          content:
            'application/json':
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "Logged out"
        default:
          $ref: '#/components/responses/GeneralError'

  /users:
    get:
      tags:
        - users
      security:
        - bearerAuth: [ ]
      
      parameters:
        - name: skip
          in: query
          description: 'Skip'
          required: false
          schema:
            $ref: '#/components/parameters/skipParam'
        - name: limit
          in: query
          description: 'Limit'
          required: false
          schema:
            $ref: '#/components/parameters/limitParam'
      responses:
        '200':
          description: "Successful users"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      tags:
        - users
      security:
        - bearerAuth: [ ]
      description: "Username update endpoint"
      requestBody:
        content:
          'application/json':
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '202':
          description: "Successful Update of Username"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/GeneralError'

  /users/me:
    get:
      tags:
        - users
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: "Currently logged in user"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      tags:
        - users
      requestBody:
        content:
          'application/json':
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: "Successful user creation"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/GeneralError'
    
    delete:
      tags:
        - users
      security:
        - bearerAuth: [ ]
      description: "Deletion of user currently logged in user"
      responses:
        '204':
          description: "Successful deletion of currently logged in user"
        default:
          $ref: '#/components/responses/GeneralError'
        
      
  /users/{id}:
    get:
      tags:
        - users
      security:
        - bearerAuth: [ ]
      description: "Retrieval of user by ID"
      responses:
        '200':
          description: "Successful retrieval of user by ID"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/GeneralError'
      # /friends (GET)
    # /friendrequest/incoming
    # /friendrequest (GET)
    # /friendrequest (POST) -> BODY {receiver_id, message}
    # /friendrequest/accept (POST) -> BODY {request_id}
    # /friendrequest/decline (POST) -> BODY {request_id}

  /friends:
    get:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Retrieval of friends of currently logged in user"
      responses:
        '200':
          description: "Successful retrieval of friends of currently logged in user"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/GeneralError'
  /friendrequest/incoming:
    get:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Retrieval of incoming friend requests of currently logged in user"
      responses:
        '200':
          description: "Successful retrieval of incoming friend requests of currently logged in user"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/GeneralError'
  /friendrequest:
    get:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Retrieval of friend requests of currently logged in user"
      responses:
        '200':
          description: "Successful retrieval of friend requests of currently logged in user"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FriendRequest'
        default:
          $ref: '#/components/responses/GeneralError'
    post:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Send friend request to user"
      requestBody:
        content:
          'application/json':
            schema:
              type: object
              properties:
                receiver_id:
                  type: integer
                message:
                  type: string
      responses:
        '202':
          description: "Successful friend request sent"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/FriendRequest'
        default:
          $ref: '#/components/responses/GeneralError'

  /friendrequest/accept:
    post:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Accept friend request"
      requestBody:
        content:
          'application/json':
            schema:
              type: object
              properties:
                request_id:
                  type: integer
      responses:
        '202':
          description: "Successful friend request accepted"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/FriendRequest'
        default:
          $ref: '#/components/responses/GeneralError'

  /friendrequest/decline:
    post:
      tags:
        - friends
      security:
        - bearerAuth: [ ]
      description: "Decline friend request"
      requestBody:
        content:
          'application/json':
            schema:
              type: object
              properties:
                request_id:
                  type: integer
      responses:
        '202':
          description: "Successful friend request declined"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/FriendRequest'
        default:
          $ref: '#/components/responses/GeneralError'

  /games:
    post:
      tags:
        - games
      description: 'Adds new game with userID as playerOne'

      responses:
        '201':
          description: "Game set up, waiting for player 2"
          content:
            'application/json':
              schema:
                $ref: "#/components/schemas/Game"
        default:
          $ref: "#/components/responses/GeneralError"

    get:
      tags:
        - games
      parameters:
        - name: skip
          in: query
          description: 'Skip'
          required: false
          schema:
            $ref: '#/components/parameters/skipParam'
        - name: limit
          in: query
          description: 'Limit'
          required: false
          schema:
            $ref: '#/components/parameters/limitParam'
        - name: active
          in: query
          description: 'Active'
          required: false
          schema:
            $ref: '#/components/parameters/activeParam'
      responses:
        '201':
          description: "Successful games"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Game'
  /games/{game_id}/join:
    put:
      tags:
        - games
      description: "User Me join game_id"
      responses:
        '202':
          description: "Join game {id}"
          content:
            'application/json':
              schema:
                type: object
                items:
                  $ref: '#/components/schemas/Game'

  /chat:
    get:
      tags:
        - chat
      security:
        - bearerAuth: [ ]
      description: "Retrieval of chats of currently logged in user"
      responses:
        '200':
          description: "Successful retrieval of chats of currently logged in user"
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Chat'
        default:
          $ref: '#/components/responses/GeneralError'
    post:
      tags:
        - chat
      security:
        - bearerAuth: [ ]
      description: "Create chat"
      requestBody:
        content:
          'application/json':
            schema:
              type: object
              properties:
                participants:
                  type: array
                  items:
                    type: object
                    properties:
                      user_id:
                        type: integer
                name:
                  type: string
      responses:
        '202':
          description: "Successful chat creation"
          content:
            'application/json':
              schema:
                type: object
                $ref: '#/components/schemas/Chat'
        default:
          $ref: '#/components/responses/GeneralError'
